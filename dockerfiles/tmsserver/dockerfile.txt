# Use NVIDIA CUDA base image with Python pre-installed
FROM nvidia/cuda:12.3.0-runtime-ubuntu22.04

# Set environment variables to avoid interactive prompts
ENV DEBIAN_FRONTEND=noninteractive

# Install only essential packages
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    python3 \
    python3-pip \
    python3-venv \
    # Minimal OpenGL/EGL dependencies
    libegl1 \
    libgl1 \
    libglu1-mesa \
    # X11 minimal dependencies (if needed by VTK)
    libxrender1 \
    libxext6 \
    libxt6 \
    libsm6 \
    libice6 \
    libx11-6 \
    libgl1-mesa-glx \
    libosmesa6 \
    # Network utilities
    netcat \
    iputils-ping \
    curl \
    telnet \
    iproute2 \
    net-tools \
    dnsutils \
    tcpdump \
    vim \
    && rm -rf /var/lib/apt/lists/* \
    && ln -s /usr/bin/python3 /usr/bin/python

# Create virtual environment
RUN python3 -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Install Python dependencies - install vtk from PyPI first, then PyTorch from CUDA index
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir \
    vtk \
    pyigtl \
    nibabel \
    && pip install --no-cache-dir \
    torch==2.0.0 \
    torchvision \
    torchaudio \
    --index-url https://download.pytorch.org/whl/cu118

# Copy application files
ARG spath=SlicerTMS
COPY ${spath}/server /app/server
COPY ${spath}/data /app/data
COPY test_port_connectivity.py /app/
COPY test_network_debug.sh /app/

# Make test scripts executable
RUN chmod +x /app/test_network_debug.sh

WORKDIR /app

EXPOSE 18944
EXPOSE 18945

CMD ["python", "server/server.py", "Example4"]